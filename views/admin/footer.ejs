<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.querySelectorAll(".dropdown-toggle-custom").forEach(toggle => {
        toggle.addEventListener("click", function () {
            const parent = this.closest(".sidebar-dropdown");
            const submenu = this.nextElementSibling;

            parent.classList.toggle("active");

            if (submenu.style.display === "block") {
                submenu.style.display = "none";
            } else {
                submenu.style.display = "block";
            }
        });
    });
</script>


<script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        // Simulate loading
        setTimeout(() => {
            document.getElementById('loadingSpinner').classList.add('hidden');
            initializeDashboard();
        }, 800);
    });

    function initializeDashboard() {
        // Initialize sidebar toggle state
        let isSidebarCollapsed = false;
        let isMobile = window.innerWidth <= 768;

        // Get DOM elements
        const sidebar = document.getElementById('sidebar');
        const content = document.getElementById('content');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarToggleContainer = document.getElementById('sidebarToggleContainer');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Initialize sidebar state from localStorage if available
        const savedState = localStorage.getItem('sidebarCollapsed');
        if (savedState !== null) {
            isSidebarCollapsed = savedState === 'true';
            if (isSidebarCollapsed && !isMobile) {
                sidebar.classList.add('collapsed');
                content.classList.add('collapsed');
                updateSidebarToggleIcon();
            }
        }

        // Desktop sidebar toggle (button outside sidebar)
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', toggleSidebar);
        }

        // Mobile menu toggle
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', toggleMobileMenu);
        }

        // Close mobile sidebar when clicking overlay
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeMobileMenu);
        }

        // Close mobile sidebar when clicking outside on mobile
        document.addEventListener('click', (event) => {
            if (isMobile && sidebar.classList.contains('mobile-open') &&
                !sidebar.contains(event.target) &&
                mobileMenuToggle && !mobileMenuToggle.contains(event.target)) {
                closeMobileMenu();
            }
        });

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 200);
        });

        // Fullscreen toggle
        const fullscreenToggle = document.getElementById('fullscreenToggle');   
        if (fullscreenToggle) {
            fullscreenToggle.addEventListener('click', toggleFullscreen);
        }

        // Notification button
        const notificationBtn = document.getElementById('notificationBtn');
        if (notificationBtn) {
            notificationBtn.addEventListener('click', showNotifications);
        }


        // Initialize charts with responsive settings
        initCharts();

        // Add hover effects to cards
        initCardHoverEffects();

        // Functions
        function toggleSidebar() {
            if (isMobile) return; // Don't toggle on mobile

            isSidebarCollapsed = !isSidebarCollapsed;

            if (isSidebarCollapsed) {
                sidebar.classList.add('collapsed');
                content.classList.add('collapsed');
                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', 'true');
            } else {
                sidebar.classList.remove('collapsed');
                content.classList.remove('collapsed');
                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', 'false');
            }

            updateSidebarToggleIcon();
        }

        function toggleMobileMenu() {
            if (!isMobile) return;

            if (sidebar.classList.contains('mobile-open')) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        function openMobileMenu() {
            if (!isMobile) return;
            sidebar.classList.add('mobile-open');
            sidebarOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            if (!isMobile) return;
            sidebar.classList.remove('mobile-open');
            sidebarOverlay.classList.remove('visible');
            document.body.style.overflow = '';
        }

        function updateSidebarToggleIcon() {
            if (!sidebarToggle) return;
            const icon = sidebarToggle.querySelector('i');
            if (isSidebarCollapsed) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        }

        function handleResize() {
            const newIsMobile = window.innerWidth <= 768;

            if (newIsMobile !== isMobile) {
                isMobile = newIsMobile;

                // Reset mobile menu state on resize to desktop
                if (!isMobile) {
                    closeMobileMenu();
                    sidebar.classList.remove('mobile-open');
                    sidebarOverlay.classList.remove('visible');
                    document.body.style.overflow = '';
                }
            }

            // Update charts on resize
            if (window.appointmentsChart) {
                window.appointmentsChart.resize();
            }
            if (window.treatmentChart) {
                window.treatmentChart.resize();
            }
            // if (window.successMetricsChart) {
            //     window.successMetricsChart.resize();
            // }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
                fullscreenToggle.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenToggle.innerHTML = '<i class="fas fa-expand"></i>';
                }
            }
        }

        function showNotifications() {
            alert('You have 5 unread notifications:\n\n1. New patient registration\n2. Lab results ready\n3. Appointment reminder\n4. Payment received\n5. System update available');
        }

        function showAlert(action) {
            alert(`${action} feature would open here.`);
        }

        function initCardHoverEffects() {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-5px)';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                });
            });
        }
    }

</script>
</body>

</html>