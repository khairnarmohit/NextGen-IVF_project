<%- include('navbar.ejs') %>
<style>
@media print {

  /* ===== Page setup ===== */
  @page {
    size: auto;
    margin: 0;
  }

  html, body {
    margin: 0 !important;
    padding: 0 !important;
    width: 100%;
    background: #fff !important;
  }

  /* ===== Hide everything ===== */
  body * {
    visibility: hidden !important;
  }

  /* ===== Show table only ===== */
  .container,
  table,
  table * {
    visibility: visible !important;
  }

  /* ===== Container fix (remove bootstrap padding) ===== */
  .container {
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* ===== Table full width ===== */
  table {
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 0 !important;
  }

  th, td {
    border: 1px solid #000 !important;
    padding: 6px !important;
    font-size: 12px;
    background: #fff !important;
    color: #000 !important;
  }

  /* ===== Hide unwanted columns & UI ===== */
  .action-col,
  .no-print,
  nav,
  footer {
    display: none !important;
  }
}



/* ===== Search Box ===== */
.search-box {
  position: relative;
  width: 280px;
}

.search-box i {
  position: absolute;
  top: 50%;
  left: 12px;
  transform: translateY(-50%);
  color: #6c757d;
  font-size: 14px;
}

.search-box input {
  width: 100%;
  padding: 8px 12px 8px 34px;
  border-radius: 6px;
  border: none;
  /* border: 1px solid #dee2e6; */
  outline: none !important;
  font-size: 14px;
  transition: 0.2s ease;
}

/* .search-box input:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 2px rgba(13,110,253,.15);
} */

</style>

<div class="container mt-4">
  <!-- <h2 class="mb-2">Appointments List</h2> -->
  <div class="mt-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <a href="/admin/appointment" class="btn btn-primary btn-sm no-print"><i
          class="fa-solid fa-plus me-2"></i> Add New Appointment</a>

      <!-- Top-right buttons (CSV + Print) -->
      <div class="d-flex gap-2 no-print">
        <button id="csvBtn" type="button" class="btn btn-success btn-sm"><i
            class="fa-solid fa-file-csv me-1"></i> CSV</button>
        <button id="printBtn" type="button" class="btn btn-secondary btn-sm"><i
            class="fa-solid fa-print me-1"></i> Print</button>
      </div>

    </div>
    <div class="search-box float-end ms-3">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input
      class="w-100 border-0 outline-0 shadow-lg"
        type="text"
        id="searchInput"
        placeholder="Search Patient / Mobile" />
    </div>

    <form method="GET" class="d-flex gap-2 align-items-center">
      <label for="date"><strong>Filter by Date:</strong></label>
      <input
        class="form-control border-0 outline-0 shadow-sm"
        type="date"
        name="date"
        style=" width: 150px; border-radius: 4px;"
        min="<%= new Date().toISOString().split('T')[0] %>"
        value="<%= Date || new Date().toISOString().split('T')[0] %>"
        onchange="this.form.submit()">
      <label class="ms-3">Reset Filter</label>
      <a href="/admin/appointments-list" class="btn btn-secondary btn-sm">Reset
        Filter</a>

    </form>
  </div>

  <p class="mb-2 bg-primary rounded-top fw-bold p-2 fs-5 text-light">All
    Appointments </p>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">Patient Name</th>
        <th scope="col">Doctor Name</th>
        <th scope="col"> Gender</th>
        <th scope="col"> Age</th>
        <th scope="col">Phone</th>
        <th scope="col">Appointment Date</th>
        <th scope="col">Status</th>
        <th scope="col" class="action-col">Action</th>
      </tr>
    </thead>
    <tbody>
      <% appointments.forEach((appointment, index) => { %>
      <tr>
        <th scope="row"><%= index + 1 %></th>
        <td><%= appointment.patient_fullname %></td>
        <td><%= appointment.doctor_name %></td>
        <td><%= appointment.patient_gender %></td>
        <td><%= appointment.patient_age %></td>
        <td><%= appointment.patient_mobile %></td>
        <td><%= appointment.appointment_date.toDateString() %></td>
        <td class="badge text-bg-warning"><%= appointment.status %></td>
        <td class="action-col">
          <a href="/admin/appointments_cancel/<%= appointment.patient_id %>"
            class="btn btn-outline-danger btn-sm"
            onclick="return confirm('Are you sure you want to cancel this appointment?');"><i
              class="fa-solid fa-square-xmark"></i></a>
          <a href="/admin/appointments_complete/<%= appointment.patient_id %>"
            class="btn btn-outline-primary btn-sm"
            onclick="return confirm('Are you sure you want to complete this appointment?');"><i
              class="fa-solid fa-circle-check"></i></a>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>

  <script>
(function() {
  const csvBtn = document.getElementById('csvBtn');
  const printBtn = document.getElementById('printBtn');
  const searchInput = document.getElementById('searchInput');
  const table = document.querySelector('table');
  const tbody = table.querySelector('tbody');

  function isRowVisible(row) {
    return row.style.display !== 'none' && getComputedStyle(row).display !== 'none';
  }

  function rowsToCsv() {
    // headers (skip action column) and escape
    const headersArr = Array.from(table.querySelectorAll('thead th'))
      .filter(th => !th.classList.contains('action-col'))
      .map(th => {
        const h = th.textContent.trim().replace(/"/g, '""');
        return (/["\n,]/).test(h) ? `"${h}"` : h;
      });

    const visibleRows = Array.from(tbody.querySelectorAll('tr')).filter(isRowVisible);

    // each visible row -> CSV line
    const dataRows = visibleRows.map(tr => {
      const cells = Array.from(tr.querySelectorAll('th, td'))
        .filter(cell => !cell.classList.contains('action-col'))
        .map(cell => {
          const text = cell.textContent.trim().replace(/"/g, '""');
          return (/["\n,]/).test(text) ? `"${text}"` : text;
        });
      return cells.join(',');
    });

    return [headersArr.join(',')].concat(dataRows).join('\n');
  }

  csvBtn.addEventListener('click', function() {
    const csvContent = rowsToCsv();
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'appointments.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  printBtn.addEventListener('click', function () {
    document.title = 'Appointments List';
    window.print();
  });

  function updateNoResults() {
    const hasVisible = Array.from(tbody.querySelectorAll('tr')).some(isRowVisible);
    let noRow = document.getElementById('noResults');
    if (!hasVisible) {
      if (!noRow) {
        noRow = document.createElement('tr');
        noRow.id = 'noResults';
        const td = document.createElement('td');
        td.colSpan = table.querySelectorAll('thead th').length;
        td.className = 'text-center text-muted';
        td.textContent = 'No matching records found';
        noRow.appendChild(td);
        tbody.appendChild(noRow);
      }
    } else if (noRow) {
      noRow.remove();
    }
  }

  function filterRows() {
    const q = searchInput.value.trim().toLowerCase();
    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
      if (tr.id === 'noResults') return;
      const cells = Array.from(tr.querySelectorAll('th, td'));
      const name = (cells[1] && cells[1].textContent.trim().toLowerCase()) || '';
      const phone = (cells[5] && cells[5].textContent.trim().toLowerCase()) || '';
      const match = q === '' || name.includes(q) || phone.includes(q);
      tr.style.display = match ? '' : 'none';
    });
    updateNoResults();
  }

  let debounce;
  searchInput.addEventListener('input', function() {
    clearTimeout(debounce);
    debounce = setTimeout(filterRows, 180);
  });

  // init
  if (searchInput.value) filterRows();
})();
</script>

  <%- include('footer.ejs') %>
